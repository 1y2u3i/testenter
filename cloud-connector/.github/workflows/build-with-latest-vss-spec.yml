# This file is maintained by velocitas CLI, do not modify manually. Change settings in .velocitas.json
# Copyright (c) 2022-2024 Contributors to the Eclipse Foundation
#
# This program and the accompanying materials are made available under the
# terms of the Apache License, Version 2.0 which is available at
# https://www.apache.org/licenses/LICENSE-2.0.
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
# WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
# License for the specific language governing permissions and limitations
# under the License.
#
# SPDX-License-Identifier: Apache-2.0

name: Build Connector with latest VSS spec

on:
  workflow_call:
    inputs:
      platform:
        required: true
        type: string
      app_name:
        required: true
        type: string

permissions:
  contents: read
  deployments: write
  packages: write
  actions: write
  checks: write


env:
  SOURCE_REPO: https://github.com/bosch-engineering/swdv.enterer.git
  AUTOMATIC_MONITOR: false
  FILES: "common/vehicle_signal_specification/*.csv" # seperate multiple entries with ,
  FILES_NEW: "common/vehicle_signal_specification/*.csv*" # seperate multiple entries with ,
  EXTRA: mv LICENSE LICENSE_some_repo # do an extra command like renaming
  # TOKEN_NAME: ACCESS_TOKEN # uncomment to use a secret with that name
  # SOURCE_BRANCH: source_alternate # uncomment to not monitor the default branch
  # TARGET_BRANCH: target_alternate # uncomment to not push to default branch


jobs:
  pull-file:
    runs-on: ubuntu-latest
    steps:      
      - name: Checkout
        uses: actions/checkout@v3

      - name: Pull File
        env:
          #THE_TOKEN: ${{ secrets.$TOKEN_NAME }}
          EVENT_NAME: ${{ github.event_name }}
          SOURCE_BRANCH: ${{ github.event.inputs.source_branch }}
          REF: ${{ github.ref }}
        run: |
          #!/bin/sh
          
          if [ -n "$TOKEN_NAME" ]; then
            REPO_URL=https://$THE_TOKEN@$SOURCE_REPO.git
          else
            REPO_URL=$SOURCE_REPO.git
          fi
          
          if [ "$EVENT_NAME" = "workflow_dispatch" ]; then
            if [ -n "$SOURCE_BRANCH" ]; then
              git clone -b $SOURCE_BRANCH $REPO_URL source-repo
            else
              git clone $REPO_URL source-repo
            fi
          else
            git clone -b $REF $REPO_URL source-repo
          fi
          cd source-repo
          $EXTRA
          cp -u $FILES_NEW ../
          cd ..
      - name: Commit
        run: |
          git config user.name "$USERNAME"
          git config user.email "$USERNAME@$ADDRESS_SUFFIX"
          git add $FILES_NEW
          git commit -m "Pulled files from $SOURCE_REPO."
      - name: Push
        run: |
          if [ -n "$TARGET_BRANCH" ]; then
            git push origin $TARGET_BRANCH
          else
            git push
          fi
  
